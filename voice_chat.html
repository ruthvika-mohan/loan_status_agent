<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Loan Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .status.idle {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status.active {
            background: #ffebee;
            color: #c62828;
            animation: pulse 2s infinite;
        }
        
        .status.ended {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-start {
            background: #4caf50;
            color: white;
        }
        
        .btn-start:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-stop {
            background: #f44336;
            color: white;
        }
        
        .btn-stop:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .transcript {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.5;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: 40px;
        }
        
        .message.agent {
            background: #f3e5f5;
            margin-right: 40px;
        }
        
        .message strong {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .user strong {
            color: #1976d2;
        }
        
        .agent strong {
            color: #7b1fa2;
        }
        
        .info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .listening-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        
        .listening-indicator.active {
            display: block;
        }
        
        .listening-indicator span {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¤ Voice Loan Status Agent</h1>
        <p class="subtitle">Browser-based voice conversation (no phone needed)</p>
        
        <div id="status" class="status idle">
            Ready to start
        </div>
        
        <div class="buttons">
            <button id="startBtn" class="btn-start">ðŸ“ž Start Call</button>
            <button id="stopBtn" class="btn-stop" disabled>ðŸ“´ End Call</button>
        </div>
        
        <div class="listening-indicator" id="listening">
            <span>ðŸŽ¤ Listening...</span>
        </div>
        
        <div class="transcript" id="transcript">
            <div class="info">
                <strong>ðŸ’¡ How to use:</strong><br>
                1. Click "Start Call" to begin<br>
                2. Allow microphone access when prompted<br>
                3. Wait for the agent to speak<br>
                4. Speak clearly when you see "Listening..."<br>
                5. Say "yes", "no", "retry", or "agent" when asked
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = 'http://localhost:8000/chat';
        
        // Initialize Web Speech API
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const synthesis = window.speechSynthesis;
        
        // Configure recognition
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;
        
        // State
        let sessionId = null;
        let isCallActive = false;
        let isSpeaking = false;
        
        // UI Elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const transcript = document.getElementById('transcript');
        const listening = document.getElementById('listening');
        
        // Text-to-Speech
        function speak(text, callback) {
            // Clean up markers
            text = text.replace('[Call ended]', '').trim();
            if (!text) {
                if (callback) callback();
                return;
            }
            
            isSpeaking = true;
            status.textContent = 'ðŸ”Š Agent speaking...';
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Choose a natural voice
            const voices = synthesis.getVoices();
            const preferredVoice = voices.find(v => 
                v.name.includes('Female') || 
                v.name.includes('Samantha') ||
                v.name.includes('Google US English')
            );
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }
            
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onend = () => {
                isSpeaking = false;
                if (callback) callback();
            };
            
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                isSpeaking = false;
                if (callback) callback();
            };
            
            synthesis.speak(utterance);
        }
        
        // Backend communication
        async function sendToAgent(userText) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: userText
                    })
                });
                
                const data = await response.json();
                return {
                    response: data.response,
                    ended: data.ended
                };
            } catch (error) {
                console.error('Backend error:', error);
                return {
                    response: "I'm having trouble connecting. Please try again.",
                    ended: false
                };
            }
        }
        
        // Add message to transcript
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'ðŸ§‘ You' : 'ðŸ¤– Agent'}</strong>${text}`;
            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;
        }
        
        // Speech recognition handlers
        recognition.onresult = async (event) => {
            const userSpeech = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;
            
            console.log(`Heard: "${userSpeech}" (confidence: ${confidence})`);
            
            listening.classList.remove('active');
            status.textContent = 'â³ Processing...';
            
            addMessage('user', userSpeech);
            
            // Send to backend
            const { response, ended } = await sendToAgent(userSpeech);
            
            addMessage('agent', response);
            
            // Check if call ended
            if (ended || response.includes('[Call ended]')) {
                status.textContent = 'âœ… Call ended';
                status.className = 'status ended';
                isCallActive = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                speak(response);
            } else {
                // Speak response and continue listening
                speak(response, () => {
                    if (isCallActive) {
                        startListening();
                    }
                });
            }
        };
        
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            listening.classList.remove('active');
            
            if (event.error === 'no-speech') {
                status.textContent = 'â“ No speech detected';
                speak("I didn't hear anything. Please try again.", () => {
                    if (isCallActive) startListening();
                });
            } else if (event.error === 'aborted') {
                // Intentional stop, do nothing
            } else {
                status.textContent = 'âŒ Recognition error';
                speak("Sorry, I had trouble hearing you. Please try again.", () => {
                    if (isCallActive) startListening();
                });
            }
        };
        
        recognition.onend = () => {
            listening.classList.remove('active');
            // Will restart automatically via callbacks if needed
        };
        
        // Start listening
        function startListening() {
            if (isCallActive && !isSpeaking) {
                status.textContent = 'ðŸŽ¤ Listening...';
                status.className = 'status active';
                listening.classList.add('active');
                recognition.start();
            }
        }
        
        // Start call
        startBtn.onclick = async () => {
            // Generate session ID
            sessionId = 'web_' + Date.now();
            isCallActive = true;
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = 'ðŸ“ž Call starting...';
            status.className = 'status active';
            
            // Clear transcript except info
            const info = transcript.querySelector('.info');
            transcript.innerHTML = '';
            if (info) transcript.appendChild(info);
            
            // Get initial greeting
            const { response, ended } = await sendToAgent('');
            
            addMessage('agent', response);
            
            // Speak greeting and start listening
            speak(response, () => {
                if (isCallActive) {
                    startListening();
                }
            });
        };
        
        // Stop call
        stopBtn.onclick = () => {
            isCallActive = false;
            recognition.stop();
            synthesis.cancel();
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'ðŸ“´ Call ended';
            status.className = 'status ended';
            listening.classList.remove('active');
            
            addMessage('agent', 'Call ended by user.');
        };
        
        // Load voices (needed for some browsers)
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = () => {
                synthesis.getVoices();
            };
        }
    </script>
</body>
</html>